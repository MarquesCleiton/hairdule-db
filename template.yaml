AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: HairduleDB - DynamoDB Table (HairduleTB)

Resources:
  HairduleTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: HairduleTB
      BillingMode: PAY_PER_REQUEST

      AttributeDefinitions:
        - { AttributeName: pk,     AttributeType: S }
        - { AttributeName: sk,     AttributeType: S }
        - { AttributeName: gsi1pk, AttributeType: S }
        - { AttributeName: gsi1sk, AttributeType: S }
        - { AttributeName: email,  AttributeType: S }
        - { AttributeName: refreshTokenHash, AttributeType: S }
        # ‚öôÔ∏è Opcional futuro ‚Äî listar usu√°rios de um neg√≥cio
        - { AttributeName: gsiBusinessUser, AttributeType: S }

      KeySchema:
        - { AttributeName: pk, KeyType: HASH }
        - { AttributeName: sk, KeyType: RANGE }

      GlobalSecondaryIndexes:
        # √çndice 1: Relacionamentos USER ‚Üí BUSINESS
        - IndexName: GSI1
          KeySchema:
            - { AttributeName: gsi1pk, KeyType: HASH }
            - { AttributeName: gsi1sk, KeyType: RANGE }
          Projection:
            ProjectionType: ALL

        # √çndice 2: Login por e-mail
        - IndexName: GSI_EMAIL
          KeySchema:
            - { AttributeName: email, KeyType: HASH }
          Projection:
            ProjectionType: ALL

        # √çndice 3: Refresh token seguro (para /auth/refresh)
        - IndexName: GSI_REFRESH_HASH
          KeySchema:
            - { AttributeName: refreshTokenHash, KeyType: HASH }
          Projection:
            ProjectionType: ALL

        # ‚öôÔ∏è √çndice 4 (opcional): listar usu√°rios de um neg√≥cio
        - IndexName: GSI_BUSINESS_USER
          KeySchema:
            - { AttributeName: gsiBusinessUser, KeyType: HASH }
          Projection:
            ProjectionType: ALL

      # TTL ativo (limpeza autom√°tica de sess√µes expiradas)
      TimeToLiveSpecification:
        AttributeName: expiresAt
        Enabled: true

      # üß© Sugest√£o de atributos padr√£o nos itens (n√£o obrigat√≥rios no schema)
      # - status: active | disabled | revoked
      # - entityType: user | session | business | role | link
      # - createdAt / updatedAt: ISO8601
      # - revokedBy (opcional, em SESSION#): USER#id ou system

Outputs:
  HairduleTableName:
    Description: Nome da tabela DynamoDB criada
    Value: !Ref HairduleTable

  HairduleTableArn:
    Description: ARN da tabela DynamoDB
    Value: !GetAtt HairduleTable.Arn
